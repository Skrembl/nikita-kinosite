<!doctype html>
<html lang="ru">
    <head>
        <meta charset="UTF-8" />
        <title>Отзывы о фильме</title>
        <link rel="stylesheet" href="styles.css" />
    </head>
    <body>
        <div class="container">
            <header class="site-header">
                <h1 id="movie-title">Загрузка…</h1>
                <p id="movie-desc" class="movie-desc">Описание...</p>
            </header>

            <main>
                <section class="reviews-section">
                    <h2>Отзывы</h2>
                    <ul id="reviews-list" class="reviews-list"></ul>
                </section>

                <section class="form-section">
                    <h2>Оставить отзыв</h2>
                    <form id="review-form" class="review-form">
                        <input
                            type="text"
                            name="name"
                            placeholder="Ваше имя"
                            required
                        />
                        <textarea
                            name="text"
                            placeholder="Ваш отзыв"
                            required
                        ></textarea>
                        <button type="submit">Отправить</button>
                    </form>
                </section>
            </main>
        </div>

        <script>
            const params = new URLSearchParams(window.location.search);
            const filmId = params.get("film_id");

            const movieData = {
                1: {
                    title: "Урок",
                    desc: "Антон был успешным музыкантом, но после аварии, в которой погибла его девушка Лиза и года в наркологической клинике он все потерял. Теперь он возвращается в родной город, где у него остался лишь старший брат Константин, который всегда был его полной противоположностью.",
                },
                2: {
                    title: "Отряд светлячков",
                    desc: "История об обороне Аджимушкайских каменоломен. Это случилось в мае 1942 года — несколько отрядов войск Крымского фронта, вместе с жителями города укрылись от бомбежек в Аджимушкайских каменоломнях. Главный герой, современный мальчик, попавший с помощью нейросетевых технологий в прошлое, оказывается перед выбором: найти утерянные артефакты или помочь защитникам каменоломен. И он принимает решение разделить все тяготы этой жизни и, главное, подарить надежду этим людям.",
                },
                3: {
                    title: "В потерянных землях",
                    desc: "После гибели техногенной цивилизации в мир вернулись магия и монстры. По тайному заданию королевы ведьма Серая Элис отправляется из последнего города Земли в опасные Потерянные земли. Вместе с проводником Бойсом ей предстоит до полной Луны найти источник силы, что может обращать человека в зверя.",
                },
                4: {
                    title: "Горная невеста",
                    desc: "Молодой солдат Пьетро приезжает в отдаленную горную деревушку Вермильо, спасаясь от войны, и остается жить в семье местного учителя. Он влюбляется в старшую дочь хозяина, и чувства молодых людей изменят жизни каждого жителя этой деревушки навсегда.",
                },
                5: {
                    title: "Конклав",
                    desc: "После внезапной смерти Папы кардиналы готовятся к конклаву — выбору нового главы католической церкви. Руководить этим сакральным таинством поручено кардиналу Лоуренсу. Духовные лидеры со всего света прибывают в Ватикан, чтобы исполнить свой важнейший долг. Но вскоре Лоуренс понимает, что среди духовенства готовится заговор, и узнает о тайне, которая может пошатнуть самые основы Церкви.",
                },
            };
            document.getElementById("movie-title").textContent =
                movieData[filmId].title;
            document.getElementById("movie-desc").textContent =
                movieData[filmId].desc;

            const reviewsList = document.getElementById("reviews-list");
            function loadReviews() {
                fetch(`api/get_reviews.php?film_id=${filmId}`)
                    .then((res) => res.json())
                    .then((data) => {
                        reviewsList.innerHTML = "";
                        if (!data.reviews || data.reviews.length === 0) {
                            reviewsList.innerHTML = "<li>Пока нет отзывов</li>";
                            return;
                        }
                        data.reviews.forEach((r) => {
                            const li = document.createElement("li");
                            li.innerHTML = `<strong>${r.name}</strong> (${r.date}):<br>${r.text}`;
                            reviewsList.appendChild(li);
                        });
                    })
                    .catch((err) => console.error("Ошибка загрузки:", err));
            }
            loadReviews();

            document
                .getElementById("review-form")
                .addEventListener("submit", (e) => {
                    e.preventDefault();
                    const formData = new FormData(e.target);
                    formData.append("film_id", filmId);
                    fetch("api/add_review.php", {
                        method: "POST",
                        body: formData,
                    })
                        .then((res) => res.json())
                        .then((resp) => {
                            if (resp.success) {
                                loadReviews();
                                e.target.reset();
                            } else {
                                alert("Ошибка: " + resp.error);
                            }
                        })
                        .catch((err) => console.error("Ошибка отправки:", err));
                });
        </script>
    </body>
</html>
